<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test POS Fixed Search</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .search-input { width: 300px; padding: 10px; border: 1px solid #ccc; border-radius: 4px; }
        #medicine-list { margin-top: 20px; }
        .medicine-card {
            border: 1px solid #ddd;
            padding: 10px;
            margin: 10px 0;
            cursor: pointer;
            border-radius: 4px;
        }
        .medicine-card:hover { background-color: #f5f5f5; }
        .inventory-wrapper {
            margin: 10px 0;
            padding: 8px;
            background: #f9f9f9;
            border-radius: 4px;
        }
        .inventory-item {
            cursor: pointer;
            padding: 4px;
            border-radius: 2px;
        }
        .inventory-item:hover { background-color: #e9e9e9; }
        .add-to-cart-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            width: 100%;
            margin-top: 8px;
        }
        .add-to-cart-btn:hover { background: #218838; }
        .add-to-cart-btn:disabled { background: #6c757d; cursor: not-allowed; }
        #prescription-items { margin-top: 20px; padding: 10px; border: 1px solid #ddd; }
        .prescription-item { padding: 5px; border-bottom: 1px solid #eee; }
    </style>
</head>
<body>
    <h1>Test POS Fixed Search & Add to Cart</h1>

    <div>
        <label>Tìm kiếm thuốc:</label><br>
        <input type="text" class="search-input" placeholder="Nhập tên thuốc..." />
    </div>

    <div id="medicine-list"></div>

    <div id="prescription-items">
        <h3>Đơn thuốc (Test):</h3>
        <div id="prescription-list"></div>
    </div>

    <script>
        console.log('Testing fixed POS functionality');

        // Mock prescription items for testing
        let prescriptionItems = [];

        // Mock data
        const mockMedicines = [
            {
                id: 1,
                name: 'Paracetamol 500mg',
                activeIngredient: 'Paracetamol',
                variants: [{
                    dosageForm: 'Viên nén',
                    strength: '500mg',
                    baseUnitName: 'viên',
                    unitConversion: [{unit: 'viên', multiplier: 1}],
                    inventories: [{
                        id: 101,
                        batchNumber: 'PCM001',
                        expiryDate: '2025-12-31',
                        quantity: 100,
                        salePrice: 15000
                    }]
                }]
            },
            {
                id: 2,
                name: 'Amoxicillin 250mg',
                activeIngredient: 'Amoxicillin',
                variants: [{
                    dosageForm: 'Capsule',
                    strength: '250mg',
                    baseUnitName: 'viên',
                    unitConversion: [{unit: 'viên', multiplier: 1}],
                    inventories: [{
                        id: 102,
                        batchNumber: 'AMX001',
                        expiryDate: '2025-06-30',
                        quantity: 50,
                        salePrice: 25000
                    }]
                }]
            }
        ];

        // DOM Elements
        const searchInput = document.querySelector('.search-input');
        const resultContainer = document.querySelector('#medicine-list');
        const prescriptionList = document.querySelector('#prescription-list');

        console.log('Elements found:', {
            searchInput: !!searchInput,
            resultContainer: !!resultContainer
        });

        let debounceTimer;

        // Search functionality
        if (searchInput) {
            searchInput.addEventListener('input', () => {
                try {
                    console.log('Search input triggered');
                    clearTimeout(debounceTimer);

                    debounceTimer = setTimeout(() => {
                        const searchTerm = searchInput.value.trim().toLowerCase();
                        console.log('Search term:', searchTerm);

                        if (searchTerm.length === 0) {
                            resultContainer.innerHTML = "";
                            return;
                        }

                        // Filter mock data
                        const filteredMedicines = mockMedicines.filter(med =>
                            med.name.toLowerCase().includes(searchTerm) ||
                            med.activeIngredient.toLowerCase().includes(searchTerm)
                        );

                        console.log('Filtered results:', filteredMedicines);
                        renderResults(filteredMedicines);
                    }, 300);
                } catch (error) {
                    console.error('Error in search:', error);
                }
            });

            console.log('Search event listener added successfully');
        } else {
            console.error('Search input not found!');
        }

        // Event delegation for clicks
        document.addEventListener('click', handleClicks);

        function handleClicks(e) {
            console.log('Click detected on:', e.target);

            // Handle add-to-cart button clicks
            if (e.target.classList.contains('add-to-cart-btn')) {
                e.stopPropagation();
                console.log('Add to cart button clicked');

                const button = e.target;
                const inventoryData = {
                    inventoryId: button.dataset.inventoryId,
                    medicineName: button.dataset.medicineName,
                    maxQuantity: parseInt(button.dataset.maxQuantity),
                    salePrice: parseFloat(button.dataset.salePrice),
                    batchNumber: button.dataset.batchNumber,
                    baseUnitName: button.dataset.baseUnitName
                };

                addItemToPrescription(inventoryData, button);
                return;
            }

            // Handle inventory-item clicks
            if (e.target.closest('.inventory-item')) {
                const item = e.target.closest('.inventory-item');
                if (e.target.tagName === 'BUTTON') return;

                console.log('Inventory item clicked');

                const inventoryData = {
                    inventoryId: item.dataset.inventoryId,
                    medicineName: item.dataset.medicineName,
                    maxQuantity: parseInt(item.dataset.maxQuantity),
                    salePrice: parseFloat(item.dataset.salePrice),
                    batchNumber: item.dataset.batchNumber,
                    baseUnitName: item.dataset.baseUnitName
                };

                addItemToPrescription(inventoryData, null);
            }
        }

        function renderResults(medicines) {
            console.log('Rendering results:', medicines);
            let html = "";

            medicines.forEach(medicine => {
                html += `
                    <div class="medicine-card">
                        <h3>${medicine.name}</h3>
                        <p>Hoạt chất: ${medicine.activeIngredient}</p>
                `;

                medicine.variants.forEach(variant => {
                    variant.inventories.forEach(inv => {
                        const expiryDate = new Date(inv.expiryDate).toLocaleDateString('vi-VN');
                        html += `
                            <div class="inventory-wrapper">
                                <div class="inventory-item"
                                     data-inventory-id="${inv.id}"
                                     data-medicine-name="${medicine.name}"
                                     data-max-quantity="${inv.quantity}"
                                     data-sale-price="${inv.salePrice}"
                                     data-batch-number="${inv.batchNumber}"
                                     data-base-unit-name="${variant.baseUnitName}"
                                     title="Click để thêm vào đơn">
                                    <strong>Số lô: ${inv.batchNumber}</strong><br>
                                    HSD: ${expiryDate}<br>
                                    Tồn kho: <strong>${inv.quantity}</strong> ${variant.baseUnitName}<br>
                                    Giá bán: <strong>${inv.salePrice.toLocaleString('vi-VN')} VNĐ</strong>
                                </div>
                                <button class="add-to-cart-btn"
                                        data-inventory-id="${inv.id}"
                                        data-medicine-name="${medicine.name}"
                                        data-max-quantity="${inv.quantity}"
                                        data-sale-price="${inv.salePrice}"
                                        data-batch-number="${inv.batchNumber}"
                                        data-base-unit-name="${variant.baseUnitName}">
                                    Thêm vào đơn
                                </button>
                            </div>
                        `;
                    });
                });

                html += `</div>`;
            });

            resultContainer.innerHTML = html;
            console.log('Results rendered, HTML length:', html.length);
        }

        function addItemToPrescription(inventoryData, button) {
            try {
                console.log('Adding to prescription:', inventoryData);

                const existingItem = prescriptionItems.find(item =>
                    item.inventoryId === inventoryData.inventoryId
                );

                if (existingItem) {
                    if (existingItem.quantity < inventoryData.maxQuantity) {
                        existingItem.quantity++;

                        if (button) {
                            button.textContent = 'Đã thêm!';
                            button.style.background = '#17a2b8';
                            setTimeout(() => {
                                button.textContent = 'Thêm vào đơn';
                                button.style.background = '#28a745';
                            }, 1000);
                        }
                    } else {
                        alert('Đã đạt tối đa tồn kho!');
                    }
                } else {
                    const newItem = {
                        inventoryId: inventoryData.inventoryId,
                        medicineName: inventoryData.medicineName,
                        batchNumber: inventoryData.batchNumber,
                        quantity: 1,
                        maxQuantity: inventoryData.maxQuantity,
                        salePrice: inventoryData.salePrice,
                        baseUnitName: inventoryData.baseUnitName
                    };

                    prescriptionItems.push(newItem);

                    if (button) {
                        button.textContent = 'Đã thêm!';
                        button.style.background = '#17a2b8';
                        setTimeout(() => {
                            button.textContent = 'Thêm vào đơn';
                            button.style.background = '#28a745';
                        }, 1000);
                    }
                }

                renderPrescription();
            } catch (error) {
                console.error('Error adding item:', error);
                alert('Lỗi: ' + error.message);
            }
        }

        function renderPrescription() {
            let html = '';
            if (prescriptionItems.length === 0) {
                html = '<p>Chưa có thuốc nào trong đơn</p>';
            } else {
                prescriptionItems.forEach((item, index) => {
                    const total = item.quantity * item.salePrice;
                    html += `
                        <div class="prescription-item">
                            ${index + 1}. ${item.medicineName} (${item.batchNumber}) -
                            ${item.quantity} ${item.baseUnitName} x
                            ${item.salePrice.toLocaleString('vi-VN')} =
                            ${total.toLocaleString('vi-VN')} VNĐ
                        </div>
                    `;
                });
            }
            prescriptionList.innerHTML = html;
            console.log('Prescription rendered, items count:', prescriptionItems.length);
        }

        console.log('Test script loaded successfully');

        // Initial render
        renderPrescription();

        // Auto-test after 2 seconds
        setTimeout(() => {
            console.log('Running auto-test...');
            searchInput.value = 'para';
            searchInput.dispatchEvent(new Event('input'));
        }, 2000);
    </script>
</body>
</html>

