@startuml
title Sequence Diagram for Shift Management (Check-in/View)
skinparam participant {
    BackgroundColor #AEE5FF
    BorderColor #000000
}
skinparam actor {
    BackgroundColor #AEE5FF
    BorderColor #000000
}
skinparam boundary {
    BackgroundColor #AEE5FF
    BorderColor #000000
}
skinparam control {
    BackgroundColor #AEE5FF
    BorderColor #000000
}
skinparam sequenceLifeLine {
    BackgroundColor #AEE5FF
    BorderColor #000000
}
skinparam sequenceActivation {
    BackgroundColor #AEE5FF
    BorderColor #000000
}

actor "Pharmacist" as Actor
boundary ":Shifts.jte" as ShiftView
boundary ":Revenues.jte" as RevenueView
control ":RevenueController" as Ctrl
participant ":ShiftService" as ShiftSvc
participant ":ShiftWorkService" as WorkSvc
participant ":UserService" as UserSvc
participant ":ShiftRepository" as ShiftRepo
participant ":ShiftWorkRepository" as WorkRepo

' --- SCENARIO 1: VIEW SHIFT LIST ---
activate Actor
Actor -> ShiftView : 1: Navigate to /pharmacist/shifts
activate ShiftView
    ShiftView -> Ctrl : 1.1: GET /pharmacist/shifts
    activate Ctrl
        note right of Ctrl: Get authenticated userId
        Ctrl -> UserSvc : 1.1.1: findById(userId)
        activate UserSvc
        UserSvc -->> Ctrl : 1.1.1.1: return User with branchId
        deactivate UserSvc

        Ctrl -> ShiftSvc : 1.1.2: getUpcomingShifts(userId, branchId)
        activate ShiftSvc
            ShiftSvc -> WorkRepo : 1.1.2.1: findUpcomingByUser(userId, branchId)
            activate WorkRepo
            alt Database Error
                WorkRepo -->> ShiftSvc : 1.1.2.1.1: throw DataAccessException
                deactivate WorkRepo
                ShiftSvc -->> Ctrl : 1.1.2.2: throw ServiceException
                Ctrl -->> ShiftView : 1.1.3: return view with error
                ShiftView --> Actor : 1.1.4: Show "Lỗi tải danh sách ca"
            else Success
                WorkRepo -->> ShiftSvc : 1.1.2.1.1: return List<ShiftWork>
                deactivate WorkRepo
                ShiftSvc -->> Ctrl : 1.1.2.2: return List<ShiftWorkDTO>
            end
        deactivate ShiftSvc

        Ctrl -> ShiftSvc : 1.1.3: getCurrentShift(userId, branchId)
        activate ShiftSvc
            ShiftSvc -> ShiftRepo : 1.1.3.1: findActiveShiftByUser(userId, branchId)
            activate ShiftRepo
            alt Database Error
                ShiftRepo -->> ShiftSvc : 1.1.3.1.1: throw DataAccessException
                deactivate ShiftRepo
                ShiftSvc -->> Ctrl : 1.1.3.2: throw ServiceException
                Ctrl -->> ShiftView : 1.1.3: return view with error
                ShiftView --> Actor : 1.1.4: Show "Lỗi kiểm tra trạng thái ca"
            else Success
                ShiftRepo -->> ShiftSvc : 1.1.3.1.1: return Optional<Shift>
                deactivate ShiftRepo
                ShiftSvc -->> Ctrl : 1.1.3.2: return Optional<Shift>
            end
        deactivate ShiftSvc

        Ctrl -->> ShiftView : 1.1.4: return view with data
        deactivate Ctrl
        ShiftView --> Actor : 1.1.5: Display shift list and status
    deactivate ShiftView

' --- SCENARIO 2: VIEW CURRENT SHIFT REVENUE ---
    Actor -> RevenueView : 2: View revenue page
    activate RevenueView
    RevenueView -> Ctrl : 2.1: GET /pharmacist/revenues
    activate Ctrl
        note right of Ctrl: Get authenticated userId
        Ctrl -> ShiftSvc : 2.1.1: getCurrentShift(userId, branchId)
        activate ShiftSvc
            ShiftSvc -> ShiftRepo : 2.1.1.1: findActiveShiftByUser(userId, branchId)
            activate ShiftRepo
            alt No Active Shift
                ShiftRepo -->> ShiftSvc : 2.1.1.1.1: return Optional.empty()
                deactivate ShiftRepo
                Svc -->> Ctrl : 2.1.1.2: return Optional.empty()
                Ctrl -->> RevenueView : 2.1.2: redirect to /pharmacist/shifts
                RevenueView --> Actor : 2.1.3: Show "Bạn chưa vào ca"
            else Database Error
                ShiftRepo -->> ShiftSvc : 2.1.1.1.1: throw DataAccessException
                deactivate ShiftRepo
                Svc -->> Ctrl : 2.1.1.2: throw ServiceException
                Ctrl -->> RevenueView : 2.1.2: return view with error
                RevenueView --> Actor : 2.1.3: Show "Lỗi tải thông tin ca"
            else Active Shift Found
                ShiftRepo -->> ShiftSvc : 2.1.1.1.2: return Optional<Shift>
                deactivate ShiftRepo
                Svc -->> Ctrl : 2.1.1.2: return Optional<Shift>
                Ctrl -->> RevenueView : 2.1.2: return view with shift data
                RevenueView --> Actor : 2.1.3: Display current shift info
            end
        deactivate Svc
    deactivate Ctrl
    deactivate RevenueView
deactivate Actor
@enduml
