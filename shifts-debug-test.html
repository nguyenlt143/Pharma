<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shifts API Debug Test</title>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/jquery.dataTables.min.css">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 10px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            background: #f9f9f9;
            border-left: 4px solid #2196F3;
        }
        .console-output {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
            margin: 10px 0;
        }
        .log-entry {
            margin: 5px 0;
            padding: 3px 0;
            border-bottom: 1px solid #333;
        }
        .log-info { color: #4FC3F7; }
        .log-warn { color: #FFB74D; }
        .log-error { color: #E57373; }
        .log-success { color: #81C784; }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #45a049;
        }
        table.dataTable {
            margin-top: 20px !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Shifts API Debug Test</h1>

        <div class="test-section">
            <h3>Test 1: Direct API Call</h3>
            <button onclick="testDirectAPI()">Test API Endpoint</button>
            <button onclick="clearConsole()">Clear Console</button>
            <div id="console1" class="console-output"></div>
        </div>

        <div class="test-section">
            <h3>Test 2: DataTables Integration</h3>
            <button onclick="initDataTable()">Initialize DataTable</button>
            <button onclick="reloadDataTable()">Reload DataTable</button>
            <div id="console2" class="console-output"></div>
            <table id="shiftTable" class="display" style="width:100%">
                <thead>
                    <tr>
                        <th>T√™n ca</th>
                        <th>Ti·ªÅn m·∫∑t</th>
                        <th>Chuy·ªÉn kho·∫£n</th>
                        <th>T·ªïng doanh thu</th>
                        <th>S·ªë ƒë∆°n h√†ng</th>
                        <th>H√†nh ƒë·ªông</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>

    <script>
        let table = null;

        function logToConsole(consoleId, message, type = 'info') {
            const console = document.getElementById(consoleId);
            const timestamp = new Date().toLocaleTimeString();
            const logClass = `log-${type}`;
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry ${logClass}`;
            logEntry.textContent = `[${timestamp}] ${message}`;
            console.appendChild(logEntry);
            console.scrollTop = console.scrollHeight;

            // Also log to browser console
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        function clearConsole() {
            document.getElementById('console1').innerHTML = '';
            document.getElementById('console2').innerHTML = '';
        }

        function testDirectAPI() {
            const consoleId = 'console1';
            logToConsole(consoleId, '=== Starting Direct API Test ===', 'info');
            logToConsole(consoleId, 'Calling /pharmacist/all/shift', 'info');

            $.ajax({
                url: 'http://localhost:8080/pharmacist/all/shift',
                type: 'GET',
                data: {
                    draw: 1,
                    start: 0,
                    length: 10,
                    'order[0][column]': 0,
                    'order[0][dir]': 'asc',
                    'columns[0][data]': 'shiftName',
                    'columns[0][name]': '',
                    'columns[0][searchable]': true,
                    'columns[0][orderable]': true,
                    'columns[0][search][value]': '',
                    'columns[0][search][regex]': false
                },
                beforeSend: function(xhr) {
                    logToConsole(consoleId, 'Request sent...', 'info');
                },
                success: function(response) {
                    logToConsole(consoleId, '‚úì API call successful!', 'success');
                    logToConsole(consoleId, `Response type: ${typeof response}`, 'info');
                    logToConsole(consoleId, `Response structure: ${JSON.stringify(Object.keys(response))}`, 'info');
                    logToConsole(consoleId, `Draw: ${response.draw}`, 'info');
                    logToConsole(consoleId, `Records Total: ${response.recordsTotal}`, 'info');
                    logToConsole(consoleId, `Records Filtered: ${response.recordsFiltered}`, 'info');
                    logToConsole(consoleId, `Data array length: ${response.data ? response.data.length : 'null'}`, 'info');

                    if (response.data && response.data.length > 0) {
                        logToConsole(consoleId, `First record: ${JSON.stringify(response.data[0], null, 2)}`, 'success');
                        logToConsole(consoleId, `First record keys: ${Object.keys(response.data[0]).join(', ')}`, 'info');

                        response.data.forEach((item, index) => {
                            logToConsole(consoleId,
                                `Record ${index + 1}: ${item.shiftName} - Orders: ${item.orderCount}, Revenue: ${item.totalRevenue}`,
                                'info');
                        });
                    } else {
                        logToConsole(consoleId, '‚ö† No data returned from API', 'warn');
                    }

                    logToConsole(consoleId, `Full response: ${JSON.stringify(response, null, 2)}`, 'info');
                },
                error: function(xhr, status, error) {
                    logToConsole(consoleId, `‚úó API call failed!`, 'error');
                    logToConsole(consoleId, `Status: ${status}`, 'error');
                    logToConsole(consoleId, `Error: ${error}`, 'error');
                    logToConsole(consoleId, `Status Code: ${xhr.status}`, 'error');
                    logToConsole(consoleId, `Response Text: ${xhr.responseText}`, 'error');
                }
            });
        }

        function initDataTable() {
            const consoleId = 'console2';

            if (table) {
                logToConsole(consoleId, 'Destroying existing DataTable...', 'warn');
                table.destroy();
                $('#shiftTable tbody').empty();
            }

            logToConsole(consoleId, '=== Initializing DataTable ===', 'info');

            table = $('#shiftTable').DataTable({
                processing: true,
                serverSide: true,
                ajax: {
                    url: 'http://localhost:8080/pharmacist/all/shift',
                    type: 'GET',
                    dataSrc: function(json) {
                        logToConsole(consoleId, '=== DataTables dataSrc function ===', 'info');
                        logToConsole(consoleId, `Raw JSON: ${JSON.stringify(json)}`, 'info');
                        logToConsole(consoleId, `Data array length: ${json.data ? json.data.length : 'null'}`, 'info');

                        if (!json.data || json.data.length === 0) {
                            logToConsole(consoleId, '‚ö† No shift data received from server', 'warn');
                        } else {
                            logToConsole(consoleId, `‚úì Received ${json.data.length} records`, 'success');
                            logToConsole(consoleId, `First row: ${JSON.stringify(json.data[0])}`, 'info');
                        }

                        return json.data;
                    },
                    error: function(xhr, error, thrown) {
                        logToConsole(consoleId, `‚úó DataTable Ajax Error`, 'error');
                        logToConsole(consoleId, `Error: ${error}`, 'error');
                        logToConsole(consoleId, `Thrown: ${thrown}`, 'error');
                        logToConsole(consoleId, `Status: ${xhr.status}`, 'error');
                        logToConsole(consoleId, `Response: ${xhr.responseText}`, 'error');
                    }
                },
                columns: [
                    {
                        data: 'shiftName',
                        render: function(data, type, row) {
                            logToConsole(consoleId, `Rendering shiftName: ${data}`, 'info');
                            return data || 'N/A';
                        }
                    },
                    {
                        data: 'cashTotal',
                        render: function(data, type, row) {
                            if (data == null || data === undefined) return '0 ‚Ç´';
                            return new Intl.NumberFormat('vi-VN', {
                                style: 'currency',
                                currency: 'VND'
                            }).format(data);
                        }
                    },
                    {
                        data: 'transferTotal',
                        render: function(data, type, row) {
                            if (data == null || data === undefined) return '0 ‚Ç´';
                            return new Intl.NumberFormat('vi-VN', {
                                style: 'currency',
                                currency: 'VND'
                            }).format(data);
                        }
                    },
                    {
                        data: 'totalRevenue',
                        render: function(data, type, row) {
                            if (data == null || data === undefined) return '0 ‚Ç´';
                            return new Intl.NumberFormat('vi-VN', {
                                style: 'currency',
                                currency: 'VND'
                            }).format(data);
                        }
                    },
                    {
                        data: 'orderCount',
                        render: function(data, type, row) {
                            return data || 0;
                        }
                    },
                    {
                        data: 'shiftName',
                        orderable: false,
                        render: function(data, type, row) {
                            if (data == null || data === undefined) {
                                return '<span style="color: #999;">Kh√¥ng c√≥ d·ªØ li·ªáu</span>';
                            }
                            return '<a href="/pharmacist/all/shift/detail/view?shiftName=' +
                                   encodeURIComponent(data) +
                                   '" class="btn btn-sm btn-primary">Xem chi ti·∫øt</a>';
                        }
                    }
                ],
                language: {
                    url: '//cdn.datatables.net/plug-ins/1.13.7/i18n/vi.json',
                    processing: 'ƒêang t·∫£i d·ªØ li·ªáu ca l√†m vi·ªác...',
                    emptyTable: 'Kh√¥ng c√≥ d·ªØ li·ªáu ca l√†m vi·ªác',
                    error: 'L·ªói khi t·∫£i d·ªØ li·ªáu ca l√†m vi·ªác',
                    zeroRecords: 'Kh√¥ng t√¨m th·∫•y ca l√†m vi·ªác n√†o'
                },
                order: [[0, 'asc']],
                pageLength: 10,
                drawCallback: function(settings) {
                    logToConsole(consoleId, `‚úì DataTable draw completed. Displayed rows: ${settings.fnRecordsDisplay()}`, 'success');
                },
                initComplete: function(settings, json) {
                    logToConsole(consoleId, '‚úì DataTable initialization completed', 'success');
                    if (json) {
                        logToConsole(consoleId, `Initial data records: ${json.recordsTotal}`, 'info');
                    }
                }
            });
        }

        function reloadDataTable() {
            if (table) {
                logToConsole('console2', 'Reloading DataTable...', 'info');
                table.ajax.reload();
            } else {
                logToConsole('console2', '‚ö† DataTable not initialized yet', 'warn');
            }
        }

        // Auto-run tests on page load
        $(document).ready(function() {
            logToConsole('console1', '‚úì jQuery loaded', 'success');
            logToConsole('console1', '‚úì DataTables loaded', 'success');
            logToConsole('console1', 'Ready to test API', 'info');
            logToConsole('console1', 'Click "Test API Endpoint" to start', 'info');
        });
    </script>
</body>
</html>

