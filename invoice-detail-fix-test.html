<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Invoice Detail for Walk-in Customers</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; }
        .test-section { border: 1px solid #ddd; padding: 15px; margin: 15px 0; border-radius: 4px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        .code { background: #f8f9fa; padding: 10px; border-radius: 4px; font-family: monospace; }
        .btn { padding: 10px 20px; background: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; margin: 5px; }
        .btn:hover { background: #0056b3; }
        .query-result { margin-top: 10px; padding: 10px; border-left: 4px solid #007bff; background: #f8f9fa; }
    </style>
</head>
<body>
    <h1>üîç Test Invoice Detail for Walk-in Customers</h1>

    <div class="test-section info">
        <h2>üìã Problem Analysis</h2>
        <p><strong>Issue:</strong> Kh√¥ng xem ƒë∆∞·ª£c chi ti·∫øt ƒë∆°n h√†ng c·ªßa kh√°ch kh√¥ng c√≥ t√™n, s·ªë ƒëi·ªán tho·∫°i</p>
        <p><strong>Root Cause:</strong> Query s·ª≠ d·ª•ng INNER JOIN v·ªõi customers table, nh∆∞ng walk-in customers (Kh√°ch l·∫ª/Kh√¥ng c√≥) kh√¥ng c√≥ customer record</p>
        <p><strong>Solution:</strong> Thay ƒë·ªïi t·ª´ INNER JOIN sang LEFT JOIN v√† s·ª≠ d·ª•ng COALESCE cho default values</p>
    </div>

    <div class="test-section">
        <h2>üîß Database Query Changes</h2>

        <h3>‚ùå Before (Problematic Query):</h3>
        <div class="code">
SELECT
    b.name AS branch_name,
    b.address AS branch_address,
    c.name AS customer_name,           -- ‚ùå NULL when no customer
    c.phone AS customer_phone,         -- ‚ùå NULL when no customer
    i.created_at,
    i.total_price,
    i.description
FROM invoices i
JOIN customers c ON i.customer_id = c.id    -- ‚ùå INNER JOIN fails when customer_id is NULL
JOIN branchs b ON i.branch_id = b.id
WHERE i.id = ?;
        </div>

        <h3>‚úÖ After (Fixed Query):</h3>
        <div class="code">
SELECT
    b.name AS branch_name,
    b.address AS branch_address,
    COALESCE(c.name, 'Kh√°ch l·∫ª') AS customer_name,      -- ‚úÖ Default to "Kh√°ch l·∫ª"
    COALESCE(c.phone, 'Kh√¥ng c√≥') AS customer_phone,     -- ‚úÖ Default to "Kh√¥ng c√≥"
    i.created_at,
    i.total_price,
    i.description
FROM invoices i
LEFT JOIN customers c ON i.customer_id = c.id           -- ‚úÖ LEFT JOIN allows NULL customer_id
JOIN branchs b ON i.branch_id = b.id
WHERE i.id = ?;
        </div>
    </div>

    <div class="test-section">
        <h2>üî¨ Test Scenarios</h2>

        <div class="query-result">
            <h3>Scenario 1: Walk-in Customer (customer_id = NULL)</h3>
            <p><strong>Invoice Data:</strong></p>
            <ul>
                <li>customer_id: NULL</li>
                <li>total_price: 150,000</li>
                <li>branch_id: 1</li>
            </ul>
            <p><strong>Expected Result:</strong></p>
            <ul>
                <li>customer_name: "Kh√°ch l·∫ª"</li>
                <li>customer_phone: "Kh√¥ng c√≥"</li>
                <li>branch_name: "Chi nh√°nh ABC"</li>
                <li>total_price: 150,000</li>
            </ul>
        </div>

        <div class="query-result">
            <h3>Scenario 2: Regular Customer (customer_id = 123)</h3>
            <p><strong>Invoice Data:</strong></p>
            <ul>
                <li>customer_id: 123</li>
                <li>customer.name: "Nguy·ªÖn VƒÉn A"</li>
                <li>customer.phone: "0901234567"</li>
            </ul>
            <p><strong>Expected Result:</strong></p>
            <ul>
                <li>customer_name: "Nguy·ªÖn VƒÉn A"</li>
                <li>customer_phone: "0901234567"</li>
            </ul>
        </div>
    </div>

    <div class="test-section">
        <h2>üõ°Ô∏è Service Layer Improvements</h2>

        <h3>Enhanced Error Handling:</h3>
        <div class="code">
// Add validation before query
if (!repository.existsById(invoiceId)) {
    throw new RuntimeException("Kh√¥ng t√¨m th·∫•y h√≥a ƒë∆°n v·ªõi ID: " + invoiceId);
}

InvoiceInfoVM info = repository.findInvoiceInfoById(invoiceId);

// Double check if query returned result
if (info == null) {
    throw new RuntimeException("Kh√¥ng th·ªÉ truy xu·∫•t th√¥ng tin h√≥a ƒë∆°n ID: " + invoiceId);
}
        </div>
    </div>

    <div class="test-section">
        <h2>üéØ Testing Steps</h2>
        <ol>
            <li><strong>Create Walk-in Invoice:</strong>
                <ul>
                    <li>Go to POS</li>
                    <li>Add items to cart</li>
                    <li>Use default "Kh√°ch l·∫ª" and "Kh√¥ng c√≥"</li>
                    <li>Complete checkout</li>
                </ul>
            </li>
            <li><strong>View Invoice List:</strong>
                <ul>
                    <li>Go to /pharmacist/invoices</li>
                    <li>Verify invoice appears in list</li>
                </ul>
            </li>
            <li><strong>View Invoice Detail:</strong>
                <ul>
                    <li>Click "Xem chi ti·∫øt" on walk-in invoice</li>
                    <li>Should display successfully</li>
                    <li>Customer name: "Kh√°ch l·∫ª"</li>
                    <li>Customer phone: "Kh√¥ng c√≥"</li>
                </ul>
            </li>
        </ol>
    </div>

    <div class="test-section success">
        <h2>‚úÖ Expected Results</h2>
        <ul>
            <li><strong>No more errors</strong> when viewing walk-in customer invoices</li>
            <li><strong>Proper display</strong> of "Kh√°ch l·∫ª" and "Kh√¥ng c√≥" in invoice details</li>
            <li><strong>Consistent behavior</strong> for both regular and walk-in customers</li>
            <li><strong>Better error messages</strong> if invoice truly doesn't exist</li>
        </ul>
    </div>

    <div class="test-section">
        <h2>üîç Manual Testing</h2>
        <button class="btn" onclick="testDatabaseQuery()">Test Database Query Logic</button>
        <button class="btn" onclick="testErrorHandling()">Test Error Handling</button>
        <button class="btn" onclick="testDefaultValues()">Test Default Values</button>

        <div id="testResults" style="margin-top: 15px;"></div>
    </div>

    <script>
        function showResult(type, title, message) {
            const resultsDiv = document.getElementById('testResults');
            const resultEl = document.createElement('div');
            resultEl.className = `test-section ${type}`;
            resultEl.innerHTML = `<h3>${title}</h3><p>${message}</p>`;
            resultsDiv.appendChild(resultEl);
        }

        function testDatabaseQuery() {
            showResult('info', 'üîç Database Query Test',
                'LEFT JOIN v·ªõi COALESCE s·∫Ω tr·∫£ v·ªÅ "Kh√°ch l·∫ª" v√† "Kh√¥ng c√≥" thay v√¨ NULL khi customer_id = NULL. ' +
                'ƒêi·ªÅu n√†y cho ph√©p xem chi ti·∫øt invoice c·ªßa walk-in customers.'
            );
        }

        function testErrorHandling() {
            showResult('info', 'üõ°Ô∏è Error Handling Test',
                'Service layer s·∫Ω ki·ªÉm tra invoice t·ªìn t·∫°i tr∆∞·ªõc khi query. ' +
                'N·∫øu kh√¥ng t·ªìn t·∫°i s·∫Ω throw exception v·ªõi message r√µ r√†ng thay v√¨ SQL error.'
            );
        }

        function testDefaultValues() {
            showResult('success', '‚úÖ Default Values Test',
                'COALESCE(c.name, "Kh√°ch l·∫ª") v√† COALESCE(c.phone, "Kh√¥ng c√≥") ƒë·∫£m b·∫£o lu√¥n c√≥ gi√° tr·ªã hi·ªÉn th·ªã, ' +
                'ngay c·∫£ khi customer record kh√¥ng t·ªìn t·∫°i.'
            );
        }

        // Auto-run initial test
        window.addEventListener('load', () => {
            showResult('success', 'üöÄ Fix Applied Successfully',
                'Database query ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t ƒë·ªÉ support walk-in customers. ' +
                'Gi·ªù ƒë√¢y c√≥ th·ªÉ xem chi ti·∫øt invoice c·ªßa "Kh√°ch l·∫ª" m√† kh√¥ng g·∫∑p l·ªói.'
            );
        });
    </script>
</body>
</html>
